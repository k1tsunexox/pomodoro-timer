import javax.swing.*;
import java.awt.*;
import java.io.InputStream;
import java.sql.*;
import java.time.LocalDate;
import java.time.format.DateTimeFormatter;
import java.util.Random;
import java.io.IOException;


public class PomodoroGUI extends JFrame {

    // --- Timer logic ---
    private final PomodoroTimer timerLogic;

    // --- UI Components ---
    private final JLabel timerLabel;
    private final JLabel quoteLabel;
    private final JComboBox<String> modeBox;
    private final JButton startBtn, pauseBtn, resetBtn, statsBtn;
    private final Timer swingTimer;
    private final Font pixelFont;
    private final String[] quotes;
    private final Random random;

    // --- Colors ---
    private final Color COLOR_PASTEL_BG = new Color(240, 248, 255);
    private final Color COLOR_PASTEL_PRIMARY = new Color(173, 216, 230);
    private final Color COLOR_PASTEL_TEXT = new Color(70, 130, 180);
    private final Color COLOR_PASTEL_BUTTON_HOVER = new Color(200, 230, 240);
    private final Color COLOR_PASTEL_BUTTON_PRESSED = new Color(150, 190, 210);

    // --- Sound ---
    private SoundManager soundManager;


    // --- Database ---
    private Connection dbConnection;
    private static final String DB_URL = "jdbc:sqlite:C:\\Users\\akini\\Java Projects\\pomodoro.db";

    public PomodoroGUI() {

        // --- Frame setup ---
        setTitle("[ • Pomodoro Timer • ]");
        setSize(540, 440);
        setDefaultCloseOperation(EXIT_ON_CLOSE);
        setLocationRelativeTo(null);
        setResizable(false);

        // --- Load custom font ---
        Font tempFont;
        try {
            InputStream fontStream = getClass().getResourceAsStream("/bytebounce.medium.ttf");
            if (fontStream == null) throw new IOException("Font not found!");
            tempFont = Font.createFont(Font.TRUETYPE_FONT, fontStream).deriveFont(Font.PLAIN, 36);
            GraphicsEnvironment.getLocalGraphicsEnvironment().registerFont(tempFont);
        } catch (Exception e) {
            tempFont = new Font("SansSerif", Font.PLAIN, 36);
        }
        pixelFont = tempFont;

        // --- Quotes ---
        quotes = new String[]{
                "Stay focused. Take a break.",
                "Discipline beats motivation.",
                "Small steps every day.",
                "You got this, one Pomodoro at a time.",
                "Work smart, rest smarter.",
                "Progress, not perfection."
        };
        random = new Random();

        // --- Timer logic ---
        timerLogic = new PomodoroTimer();

        // --- Sounds ---
        soundManager = new SoundManager();
        
        // --- Database init ---
        initDatabase();

        // --- UI Panel ---
        JPanel uiPanel = new JPanel(null);
        uiPanel.setBackground(COLOR_PASTEL_BG);

        // Mode dropdown
        modeBox = new JComboBox<>(new String[]{"short focus", "short break", "long break"});
        modeBox.setFont(pixelFont.deriveFont(Font.PLAIN, 20));
        modeBox.setBounds(125, 20, 300, 30);
        customizeJComboBox(modeBox);
        uiPanel.add(modeBox);

        // Timer label
        timerLabel = new JLabel(timerLogic.formatTime(), SwingConstants.CENTER);
        timerLabel.setFont(pixelFont.deriveFont(Font.PLAIN, 100));
        timerLabel.setForeground(COLOR_PASTEL_TEXT);
        timerLabel.setBounds(115, 120, 300, 80);
        uiPanel.add(timerLabel);

        // Quote label
        quoteLabel = new JLabel(quotes[0], SwingConstants.CENTER);
        quoteLabel.setFont(pixelFont.deriveFont(Font.PLAIN, 25));
        quoteLabel.setForeground(COLOR_PASTEL_TEXT);
        quoteLabel.setBounds(60, 200, 400, 40);
        uiPanel.add(quoteLabel);

        // Buttons
        startBtn = new JButton("Start");
        pauseBtn = new JButton("Pause");
        resetBtn = new JButton("Reset");
        statsBtn = new JButton("Stats");

        JButton[] buttons = {startBtn, pauseBtn, resetBtn, statsBtn};
        int x = 50;
        for (JButton btn : buttons) {
            btn.setFont(pixelFont.deriveFont(Font.PLAIN, 20));
            btn.setBounds(x, 300, 100, 40);
            customizeJButton(btn);
            uiPanel.add(btn);
            x += 110;
        }

        add(uiPanel);

        // --- Button actions ---
        startBtn.addActionListener(e -> {
            timerLogic.start();
            soundManager.playSound("chimes.wav");
        });

        pauseBtn.addActionListener(e -> timerLogic.pause());

        resetBtn.addActionListener(e -> {
            timerLogic.reset();
            timerLabel.setText(timerLogic.formatTime());
            updateQuote();
        });

        statsBtn.addActionListener(e -> showStatsDialog());

        // Mode selection
        modeBox.addActionListener(e -> {
            String selected = (String) modeBox.getSelectedItem();
            PomodoroTimer.Mode modeToSet = switch (selected) {
                case "short focus" -> PomodoroTimer.Mode.FOCUS;
                case "short break" -> PomodoroTimer.Mode.SHORT_BREAK;
                default -> PomodoroTimer.Mode.FOCUS;
            };
            timerLogic.setCurrentMode(modeToSet);
            timerLabel.setText(timerLogic.formatTime());
            updateQuote();
        });

        // --- Swing timer for countdown ---
        swingTimer = new Timer(1000, e -> {
            boolean finished = timerLogic.tickAndCheckFinished();
            timerLabel.setText(timerLogic.formatTime());
            if (finished) {
                soundManager.playSound("/chimes.wav");
                recordSession(timerLogic.getCurrentMode());
                timerLogic.nextMode();
                timerLabel.setText(timerLogic.formatTime());
                updateQuote();
            }
        });
        swingTimer.start();
    }

    // --- Database methods ---
    private void initDatabase() {
        try {
            Class.forName("org.sqlite.JDBC");
            dbConnection = DriverManager.getConnection(DB_URL);
            try (Statement stmt = dbConnection.createStatement()) {
                stmt.execute("CREATE TABLE IF NOT EXISTS sessions (" +
                        "id INTEGER PRIMARY KEY AUTOINCREMENT," +
                        "date TEXT NOT NULL," +
                        "mode TEXT NOT NULL," +
                        "duration_minutes INTEGER NOT NULL," +
                        "timestamp DATETIME DEFAULT CURRENT_TIMESTAMP)");
            }
        } catch (Exception e) {
            e.printStackTrace();
            dbConnection = null;
        }
    }

    private void recordSession(PomodoroTimer.Mode mode) {
        if (dbConnection == null) return;
        try (PreparedStatement stmt = dbConnection.prepareStatement(
                "INSERT INTO sessions (date, mode, duration_minutes) VALUES (?, ?, ?)")) {
            stmt.setString(1, LocalDate.now().format(DateTimeFormatter.ISO_LOCAL_DATE));
            stmt.setString(2, mode.name());
            stmt.setInt(3, timerLogic.getModeDurationInMinutes(mode));
            stmt.executeUpdate();
        } catch (SQLException e) {
            e.printStackTrace();
        }
    }

    // --- Stats Dialog ---
    private void showStatsDialog() {
        if (dbConnection == null) return;
        JDialog statsDialog = new JDialog(this, "Usage Statistics", true);
        statsDialog.setSize(450, 350);
        statsDialog.setLocationRelativeTo(this);
        statsDialog.setLayout(new BorderLayout());

        JTextArea statsArea = new JTextArea();
        statsArea.setEditable(false);
        statsArea.setFont(pixelFont.deriveFont(Font.PLAIN, 16));
        statsArea.setBackground(COLOR_PASTEL_BG);
        statsArea.setForeground(COLOR_PASTEL_TEXT);

        try (Statement stmt = dbConnection.createStatement()) {
            ResultSet rs = stmt.executeQuery(
                    "SELECT date, mode, COUNT(*) AS count FROM sessions GROUP BY date, mode ORDER BY date DESC, mode"
            );
            StringBuilder stats = new StringBuilder("--- Pomodoro Usage ---\n\n");
            String currentDay = "";
            while (rs.next()) {
                String date = rs.getString("date");
                String mode = rs.getString("mode");
                int count = rs.getInt("count");
                if (!date.equals(currentDay)) {
                    if (!currentDay.isEmpty()) stats.append("\n");
                    stats.append("Date: ").append(date).append("\n");
                    currentDay = date;
                }
                stats.append("  ").append(mode).append(": ").append(count).append(" sessions\n");
            }
            statsArea.setText(stats.toString());
        } catch (SQLException e) {
            statsArea.setText("Error loading statistics.");
        }

        statsDialog.add(new JScrollPane(statsArea), BorderLayout.CENTER);
        JButton closeBtn = new JButton("Close");
        closeBtn.addActionListener(e -> statsDialog.dispose());
        statsDialog.add(closeBtn, BorderLayout.SOUTH);
        statsDialog.setVisible(true);
    }

    // --- Custom UI ---
    private void customizeJButton(JButton btn) {
        btn.setBackground(COLOR_PASTEL_PRIMARY);
        btn.setForeground(COLOR_PASTEL_TEXT);
        btn.setBorder(new PixelBorder(COLOR_PASTEL_TEXT, 2));
        btn.setFocusPainted(false);
    }

    private void customizeJComboBox(JComboBox<String> comboBox) {
        comboBox.setBackground(COLOR_PASTEL_PRIMARY);
        comboBox.setForeground(COLOR_PASTEL_TEXT);
        comboBox.setBorder(new PixelBorder(COLOR_PASTEL_TEXT, 2));
    }

    private void updateQuote() {
        quoteLabel.setText(quotes[random.nextInt(quotes.length)]);
    }

    public static void main(String[] args) {
        SwingUtilities.invokeLater(() -> {
            PomodoroGUI gui = new PomodoroGUI();
            gui.setVisible(true);
        });
    }
}


// --- Pixel Border ---
class PixelBorder implements javax.swing.border.Border {
    private final Color color;
    private final int thickness;

    public PixelBorder(Color color, int thickness) {
        this.color = color;
        this.thickness = thickness;
    }

    @Override
    public void paintBorder(Component c, Graphics g, int x, int y, int width, int height) {
        g.setColor(color);
        g.fillRect(x, y, width, thickness);
        g.fillRect(x, y + height - thickness, width, thickness);
        g.fillRect(x, y + thickness, thickness, height - 2 * thickness);
        g.fillRect(x + width - thickness, y + thickness, thickness, height - 2 * thickness);
    }

    @Override
    public Insets getBorderInsets(Component c) {
        return new Insets(thickness, thickness, thickness, thickness);
    }

    @Override
    public boolean isBorderOpaque() {
        return true;
    }
}
